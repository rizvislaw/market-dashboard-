<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Financial Dashboard</title>
    <style>
        /* Previous styles remain unchanged */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .loader {
            border: 3px solid var(--card-bg);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains -->
    <script>
        const TWELVE_DATA_API = '889b65b7d0e8480da2f69cb725c39655';
        const NEWS_API = '998d62e180684a9580646f425d7f142e';

        // Enhanced Data Fetching with Error Handling
        async function safeFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch failed:', error);
                showNotification('Data update failed. Trying again...');
                return null;
            }
        }

        // Real-Time Price Updates
        async function updateAllPrices() {
            // Update metal prices
            const metals = await Promise.all(['XAU/USD', 'XAG/USD'].map(async symbol => {
                const data = await safeFetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=${TWELVE_DATA_API}`);
                return data ? {symbol, price: data.price} : null;
            }));
            
            metals.filter(Boolean).forEach(metal => {
                document.querySelector(`#metals-prices [data-symbol="${metal.symbol}"]`).textContent = `$${metal.price}`;
            });

            // Update portfolio values
            if(portfolio.length > 0) {
                portfolio.forEach(async (item, index) => {
                    const price = await getCurrentPrice(item.symbol);
                    document.querySelector(`#portfolio-list .item-${index} .price`).textContent = `$${price}`;
                });
            }
        }

        // Enhanced Chart Loading with Error Fallback
        function createChart(container, symbol, studies = []) {
            try {
                return new TradingView.LightweightWidget({
                    "container": `#${container}`,
                    "symbol": symbol,
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": document.body.classList.contains('dark-mode') ? 'dark' : 'light',
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "studies": studies,
                    "allow_symbol_change": false
                });
            } catch (error) {
                console.error('Chart error:', error);
                document.getElementById(container).innerHTML = 
                    `<p>Chart load failed. Refresh page or try different symbol</p>`;
            }
        }

        // Live News Updates
        async function updateNews() {
            const newsContainer = document.getElementById('news-feed');
            newsContainer.innerHTML = '<div class="loader"></div>';
            
            const data = await safeFetch(
                `https://newsapi.org/v2/top-headlines?country=pk&category=business&pageSize=10&apiKey=${NEWS_API}`
            );

            if(data && data.articles) {
                newsContainer.innerHTML = data.articles.slice(0, 5).map(article => `
                    <div class="news-item">
                        <h4>${article.title}</h4>
                        <p>${article.source.name} â€¢ ${new Date(article.publishedAt).toLocaleTimeString()}</p>
                    </div>
                `).join('');
            } else {
                newsContainer.innerHTML = 'Failed to load news. Please try again later.';
            }
        }

        // Enhanced Portfolio Management
        async function updatePortfolioDisplay() {
            const portfolioList = document.getElementById('portfolio-list');
            portfolioList.innerHTML = '<div class="loader"></div>';

            const portfolioWithPrices = await Promise.all(portfolio.map(async item => {
                const price = await getCurrentPrice(item.symbol);
                return {...item, price};
            }));

            portfolioList.innerHTML = portfolioWithPrices.map((item, index) => `
                <div class="portfolio-item item-${index}">
                    <span>${item.symbol}</span>
                    <span class="price">$${item.price.toFixed(2)}</span>
                    <span>$${(item.qty * item.price).toFixed(2)}</span>
                </div>
            `).join('');
        }

        // Live Alert Checking
        async function checkAlerts() {
            const alertPromises = alerts.map(async (alert, index) => {
                const currentPrice = await getCurrentPrice(alert.symbol);
                if (!currentPrice) return;
                
                const conditionMet = (
                    (alert.condition === 'above' && currentPrice > alert.price) ||
                    (alert.condition === 'below' && currentPrice < alert.price)
                );

                if (conditionMet) {
                    showNotification(`${alert.symbol} is now $${currentPrice.toFixed(2)} (${alert.condition} $${alert.price})`);
                    alerts.splice(index, 1);
                    localStorage.setItem('alerts', JSON.stringify(alerts));
                }
            });

            await Promise.all(alertPromises);
        }

        // Auto-Refresh System
        function startLiveUpdates() {
            setInterval(() => {
                updateAllPrices();
                updateNews();
                checkAlerts();
            }, 30000); // Update every 30 seconds

            setInterval(() => {
                refreshCharts();
            }, 300000); // Refresh charts every 5 minutes
        }

        // Initialize Everything
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            
            // Initial Load
            Promise.all([
                loadStockChart(),
                loadMetalPrices(),
                loadCryptoChart('BTC/USD'),
                updateNews(),
                loadSectorPerformance(),
                updatePortfolioDisplay()
            ]).then(startLiveUpdates);
            
            // Initialize TradingView
            if(typeof TradingView === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html>
